---
title: "Visium Spatial Tx - Mouse Hippocampus (hip142079) - 01.spatial"
author: '[Kevin Lebrigand](mailto:lebrigand@ipmc.cnrs.fr) CNRS Senior Scientist - Computational Biology'
date: 'Compiled: `r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '3'
  html_notebook:
    code_folding: none
    theme: journal
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---

<style type="text/css">

body, td {
   font-size: 15px;
}
code.r{
  font-size: 15px;
}
pre {
  font-size: 15px
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  cache = FALSE,
  cache.lazy = FALSE,
  tidy = TRUE
)
```

# Loading Spatial data

```{r message=FALSE, warning=FALSE, echo=FALSE, eval=T, fig.height=4, fig.width=6}

setwd("/data/10x_data/10x_visium/")
source("00.import.R")

hip142079 <- Load10X_Spatial(data.dir = "/data/10x_data/000-notebooks/visium/142079-spatial-hippo")

#ribo.genes <- grep(pattern = "^Rp[sl]", x = rownames(data))
#mito.genes <- grep(pattern = "^mt-", x = rownames(data))
#data <- data[-c(ribo.genes,mito.genes),]

VlnPlot(hip142079, features = c("nCount_Spatial","nFeature_Spatial"), pt.size = 0.1) + NoLegend() + ggtitle("hip142079 nCount_Spatial")
SpatialFeaturePlot(hip142079, features = c("nCount_Spatial","nFeature_Spatial"), max.cutoff = 200, pt.size.factor = 2) + theme(legend.position = "right") + ggtitle("hip142079 nCount_Spatial")

```

# Quality control, no filtration

```{r message=FALSE, warning=FALSE, echo=FALSE, eval=T, fig.height=6, fig.width=16}

mito.genes <- grep(pattern = "^mt-", x = rownames(hip142079@assays$Spatial), value = TRUE)
dropouts <- Matrix::colSums(hip142079@assays$Spatial@data == 0)/nrow(hip142079@assays$Spatial)
ribo.genes <- grep(pattern = "^Rp[sl]", x = rownames(hip142079@assays$Spatial), value = TRUE)
percent.mito <- Matrix::colSums(hip142079@assays$Spatial[mito.genes, ])/Matrix::colSums(hip142079@assays$Spatial)
percent.ribo <- Matrix::colSums(hip142079@assays$Spatial[ribo.genes, ])/Matrix::colSums(hip142079@assays$Spatial)
hip142079[['percent.mito']] <- percent.mito
hip142079[['percent.ribo']] <- percent.ribo
hip142079[['dropouts']] <- dropouts

VlnPlot(hip142079, features = c("nFeature_Spatial", "nCount_Spatial","dropouts","percent.ribo","percent.mito"), ncol=5, cols = "lightsteelblue3")
SpatialFeaturePlot(hip142079, features = c("percent.mito"), max.cutoff = 30000, pt.size.factor = 2) + 
  theme(legend.position = "right")

```

# SCTransform normalization and clustering

```{r message=FALSE, warning=FALSE, echo=FALSE, eval=T, fig.height=4, fig.width=6}

hip142079 <- SCTransform(hip142079, assay = "Spatial", verbose = FALSE)
hip142079 <- RunPCA(hip142079, assay = "SCT", verbose = FALSE)
hip142079 <- RunUMAP(hip142079, reduction = "pca", dims = 1:30)
hip142079 <- FindNeighbors(hip142079, reduction = "pca", dims = 1:30)
hip142079 <- FindClusters(hip142079, verbose = FALSE, resolution = 0.4)

DimPlot(hip142079, reduction = "umap", label = TRUE) + ggtitle("hip142079")
SpatialDimPlot(hip142079, label = TRUE, label.size = 3, pt.size.factor = 2) + ggtitle("hip142079")

#SpatialDimPlot(hip142079, interactive = TRUE)
#top.features <- head(SpatiallyVariableFeatures(hip142079, selection.method = "markvariogram"), 6)
#SpatialFeaturePlot(brain, features = top.features, ncol = 3, alpha = c(0.1, 1))

```

# Clusters re-labelling

```{r message=FALSE, warning=FALSE, echo=FALSE, eval=T, fig.height=4, fig.width=6}

#new.cluster.ids <- c("Midbrain","Hippocampus","Isocortex-2","Entorhinal area","Olfactory area","Fiber tracts","CA1/CA2","Isocortex-1","Optic nerve","Hypothalamus","Thalamus","DG-sg","RSPv2","CA3sp")
#names(x = new.cluster.ids) <- levels(x = hip142079)
#hip142079 <- RenameIdents(object = hip142079, new.cluster.ids)

#my_levels <- c("Midbrain","Hippocampus","Isocortex-1","Isocortex-2","Entorhinal area","Olfactory area","RSPv2","Fiber tracts","Optic nerve","Hypothalamus","Thalamus","DG-sg","CA1/CA2","CA3sp")
# Relevel object@ident
#hip142079@active.ident <- factor(x = hip142079@active.ident, levels = my_levels)

new.cluster.ids <- c("Midbrain","Hippocampus area","Isocortex-1","Isocortex-1","Olfactory area","Fiber tracts", "CA1/CA2", "Isocortex-2", "Hippocampus area", "Hypothalamus", "Thalamus", "DG", "Retrosplenial area", "CA3")
names(x = new.cluster.ids) <- levels(x = hip142079)
hip142079 <- RenameIdents(object = hip142079, new.cluster.ids)

my_levels <- c("Midbrain","Hippocampus area","Isocortex-1","Isocortex-2","Olfactory area","Fiber tracts","Retrosplenial area","CA1/CA2","Thalamus","Hypothalamus","CA3","DG")
# Relevel object@ident
hip142079@active.ident <- factor(x = hip142079@active.ident, levels = my_levels)

SpatialDimPlot(hip142079, label = TRUE, label.size = 3, pt.size.factor =1.5) + ggtitle("hip142079")

```

# Gene Markers Heatmap

```{r message=FALSE, warning=FALSE, echo=FALSE, eval=T, fig.height=10, fig.width=10 }

DefaultAssay(object = hip142079) <- "SCT"
hip142079 <- ScaleData(object = hip142079, verbose = FALSE)
markers <- FindAllMarkers(object = hip142079, only.pos = TRUE)
top <- markers %>% group_by(cluster) %>% top_n(5, avg_logFC)
DoHeatmap(hip142079, features=top$gene, size=3.5)

write.table(markers, file="./output/hip142079.markers.csv", sep=",")

```

# Correlation between clusters

```{r message=FALSE, warning=FALSE, echo=FALSE, eval=T, fig.height=6, fig.width=8}

hip142079@meta.data$ClusterName <- hip142079@active.ident

mnmat <- c()
uniq <- unique(hip142079@active.ident)
for(i in 1:length(uniq)){
  mnmat <- cbind(mnmat, apply(as.matrix(hip142079@assays$SCT@data[, hip142079@meta.data$ClusterName==uniq[i]]), 1, mean))
}

colnames(mnmat) <- as.vector(unique(hip142079@active.ident))
ct=cor(mnmat)
pheatmap(ct)

```

# Gene Markers Visualization

```{r message=FALSE, warning=FALSE, echo=FALSE, eval=T, fig.height=6, fig.width=8 }

hip142079 <- FindSpatiallyVariableFeatures(hip142079, assay = "SCT", features = VariableFeatures(hip142079)[1:1000], selection.method = "markvariogram")
top.features <- head(SpatiallyVariableFeatures(hip142079, selection.method = "markvariogram"), 6)
SpatialFeaturePlot(hip142079, features = top.features, ncol = 3, alpha = c(0.1, 1))

SpatialFeaturePlot(hip142079, features = c("Mbp","Pvalb"), ncol=2, pt.size.factor =2)
SpatialFeaturePlot(hip142079, features = c("Hopx","Mgp"), ncol=2, pt.size.factor =2)
SpatialFeaturePlot(hip142079, features = c("Myl4","Pcp4"), ncol=2, pt.size.factor =2)
SpatialFeaturePlot(hip142079, features = c("Camk2n1","Egr1"), ncol=2, pt.size.factor =2)
SpatialFeaturePlot(hip142079, features = c("Trh","Hpcal1"), ncol=2, pt.size.factor =2)
SpatialFeaturePlot(hip142079, features = c("Mal","Plp1"), ncol=2, pt.size.factor =2)
SpatialFeaturePlot(hip142079, features = c("Satb1","Tshz2"), ncol=2, pt.size.factor =2)
SpatialFeaturePlot(hip142079, features = c("Fibcd1","Spink8"), ncol=2, pt.size.factor =2)
SpatialFeaturePlot(hip142079, features = c("Zic1","Adarb1"), ncol=2, pt.size.factor =2)
SpatialFeaturePlot(hip142079, features = c("Slc18a2","Slc6a3"), ncol=2, pt.size.factor =2)
SpatialFeaturePlot(hip142079, features = c("Cpne6","Nnat"), ncol=2, pt.size.factor =2)
SpatialFeaturePlot(hip142079, features = c("C1ql2","Cebpd"), ncol=2, pt.size.factor =2)
SpatialFeaturePlot(hip142079, features = c("Lhx1os","Gpx3"), ncol=2, pt.size.factor =2)

```

# Integration of external data (Zeisel et al., Cell, 2018) (http://mousebrain.org/downloads.html) (8k cells downsampling)

```{r message=FALSE, warning=FALSE, echo=FALSE, eval=T, fig.height=6, fig.width=8}

#zeisel <- readRDS("/data/10x_data/10x_mouseatlas/sub8k.rds")
#head(zeisel@meta.data)
#zeisel <- SCTransform(zeisel, ncells = 3000, verbose = FALSE) %>% RunPCA(verbose = FALSE) %>% RunUMAP(dims = 1:30)
#saveRDS(zeisel, "./output/zeisel.rds")

zeisel <- readRDS("./output/zeisel.rds")
anchors <- FindTransferAnchors(reference = zeisel, query = hip142079, normalization.method = "SCT")

```

## Prediction based on metadata field "Region"

```{r message=FALSE, warning=FALSE, echo=FALSE, eval=T, fig.height=8, fig.width=14}

DefaultAssay(zeisel) <- "SCT"
DimPlot(zeisel, group.by = "Region", label = TRUE)
predictions.assay <- TransferData(anchorset = anchors, refdata = zeisel$Region, prediction.assay = TRUE,  weight.reduction = hip142079[["pca"]])
hip142079[["predRegion"]] <- predictions.assay
DefaultAssay(hip142079) <- "predRegion"

```

```{r message=FALSE, warning=FALSE, echo=FALSE, eval=T, fig.height=8, fig.width=10}

DotPlot(hip142079, features = sort(rownames(hip142079@assays$predRegion@data))) + RotatedAxis()

hip142079 <- FindSpatiallyVariableFeatures(hip142079, assay = "predRegion", features = rownames(hip142079@assays$predRegion@data), r.metric = 5, slot = "data", selection.method = "markvariogram")
top.clusters <- head(SpatiallyVariableFeatures(hip142079), 4)
SpatialFeaturePlot(hip142079, features = top.clusters, pt.size.factor = 1, ncol = 2, alpha = c(0.1, 1))

```

## Prediction based on metadata field "TaxonomyRank4"

```{r message=FALSE, warning=FALSE, echo=FALSE, eval=T, fig.height=8, fig.width=14}

DimPlot(zeisel, group.by = "TaxonomyRank4", label = TRUE)
predictions.assay <- TransferData(anchorset = anchors, refdata = zeisel$TaxonomyRank4, prediction.assay = TRUE,  weight.reduction = hip142079[["pca"]])
hip142079[["predTaxonomyRank4"]] <- predictions.assay
DefaultAssay(hip142079) <- "predTaxonomyRank4"

DotPlot(hip142079, features = sort(rownames(hip142079@assays$predTaxonomyRank4@data))) + RotatedAxis()

```

```{r message=FALSE, warning=FALSE, echo=FALSE, eval=T, fig.height=8, fig.width=10}

hip142079 <- FindSpatiallyVariableFeatures(hip142079, assay = "predTaxonomyRank4", features = rownames(hip142079@assays$predTaxonomyRank4@data), r.metric = 5, slot = "data", selection.method = "markvariogram")
top.clusters <- head(SpatiallyVariableFeatures(hip142079), 4)
SpatialFeaturePlot(hip142079, features = top.clusters, pt.size.factor = 1, ncol = 2, alpha = c(0.1, 1))

```

## Prediction based on metadata field "ClusterName"

```{r message=FALSE, warning=FALSE, echo=FALSE, eval=T, fig.height=8, fig.width=14}

DimPlot(zeisel, group.by = "ClusterName", label = TRUE)
predictions.assay <- TransferData(anchorset = anchors, refdata = zeisel$ClusterName, prediction.assay = TRUE,  weight.reduction = hip142079[["pca"]])
hip142079[["predClusterName"]] <- predictions.assay

DefaultAssay(hip142079) <- "predClusterName"
p1 = DotPlot(hip142079, features = sort(rownames(hip142079@assays$predClusterName@data))) + RotatedAxis()
p1 + theme(axis.text.x = element_text(size = 6)) + xlab("Cluster")

```

```{r message=FALSE, warning=FALSE, echo=FALSE, eval=T, fig.height=8, fig.width=10}

hip142079 <- FindSpatiallyVariableFeatures(hip142079, assay = "predClusterName", features = rownames(hip142079@assays$predClusterName@data), r.metric = 5, slot = "data", selection.method = "markvariogram")
top.clusters <- head(SpatiallyVariableFeatures(hip142079), 12)
SpatialFeaturePlot(hip142079, features = top.clusters, pt.size.factor = 1, ncol = 2, alpha = c(0.1, 1))

# remove 1 spot outside the brain section in the top of the image
hip142079 <- subset(hip142079, subset = nCount_Spatial > 105)

saveRDS(hip142079, "./output/hip142079.rds")

```

# Session Info

```{r sessinf}
sessionInfo()
```

